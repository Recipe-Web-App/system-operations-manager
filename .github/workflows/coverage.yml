name: Code Coverage

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.14"
  COVERAGE_THRESHOLD: 80

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Check Code Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --all-extras

      - name: Run tests with coverage
        run: |
          poetry run pytest --cov=system_operations_manager --cov-report=xml --cov-report=term

      - name: Calculate coverage percentage
        id: coverage
        run: |
          COVERAGE=$(poetry run coverage report --format=total 2>/dev/null || echo "0")
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "Current coverage: ${COVERAGE}%"

      - name: Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "0" ]; then
            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "Coverage ${COVERAGE}% is below threshold ${{ env.COVERAGE_THRESHOLD }}%"
              exit 1
            fi
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const threshold = '${{ env.COVERAGE_THRESHOLD }}';
            const status = parseFloat(coverage) >= parseFloat(threshold) ? '✅' : '❌';

            const body = `## ${status} Code Coverage Report

            **Overall Coverage:** ${coverage}%
            **Threshold:** ${threshold}%`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
