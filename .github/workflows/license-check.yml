name: License Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "pyproject.toml"
      - "uv.lock"
  schedule:
    - cron: "0 6 * * 1" # Monday at 6 AM UTC
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.14"

permissions:
  contents: read
  pull-requests: write

jobs:
  license-check:
    name: Check Dependency Licenses
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Install pip-licenses
        run: uv pip install pip-licenses

      - name: Generate license report
        run: |
          uv run pip-licenses --format=markdown --output-file=licenses.md
          uv run pip-licenses --format=json --output-file=licenses.json

      - name: Check for problematic licenses
        id: check
        continue-on-error: true
        run: |
          uv run pip-licenses --fail-on="GPL-3.0;AGPL-3.0;LGPL-3.0" || echo "problematic_licenses=true" >> $GITHUB_OUTPUT

      - name: Upload license report
        uses: actions/upload-artifact@v6
        with:
          name: license-report
          path: |
            licenses.md
            licenses.json
          retention-days: 90

      - name: Comment on PR if problematic licenses found
        if: github.event_name == 'pull_request' && steps.check.outputs.problematic_licenses == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '⚠️ **License Warning**: This PR introduces dependencies with potentially problematic licenses (GPL-3.0, AGPL-3.0, or LGPL-3.0). Please review the license report artifact.'
            });
